<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ADAS - Vai iet uz universitāti?</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./vendor/css/uikit.min.css"/>
</head>
<body>
<div id="app">
    <div class="uk-child-width-expand@s uk-text-center uk-padding" uk-grid>
        <div class="uk-width-1-2">
            <div class="uk-card uk-card-default uk-card-body">
                <form class="uk-form-stacked">
                    <div>
                        <legend class="uk-legend">Jautājumi</legend>
                        <p class="uk-text-left">Izvēleties kritērijus un nospiediet pogu Analizēt.</p>
                    </div>
                    <div class="uk-margin uk-text-left">
                        <div v-for="(question, key) in questions" :key="key" class="uk-margin uk-grid-small uk-child-width-auto uk-grid">
                            <label>
                                <input v-model="question.checked" class="uk-checkbox" type="checkbox">
                                <span>{{question.text}}</span>
                                <span uk-icon="info" :uk-tooltip="key"></span>
                            </label>
                        </div>
                    </div>
                    <div class="uk-margin-large-top">
                        <button @click.prevent="analyze" class="uk-button uk-button-primary">Analizēt</button>
                    </div>
                    <div class="uk-margin">
                        <div v-if="result" class="uk-text-left">
                            <strong v-if="answer">Rezultāts: {{ answer }}</strong>
                            <strong v-else>Nav pārvarēta pārliecības koef. robeža</strong>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="uk-width-1-2">
            <div class="uk-card uk-card-default uk-card-body">
                <form class="uk-form-stacked">
                    <div>
                        <legend class="uk-legend">Apmācība</legend>
                        <p class="uk-text-left">Izvēlēties kritērijus un sagaidāmo rezultātu.</p>
                    </div>
                    <div class="uk-margin uk-text-left">
                        <div v-for="(question, key) in questions" :key="key" class="uk-margin uk-grid-small uk-child-width-auto uk-grid">
                            <label>
                                <input v-model="question.learnChecked" class="uk-checkbox" type="checkbox">
                                <span>{{ question.text }} (koef. {{ question.coef.toFixed(2) }})</span>
                            </label>
                        </div>
                    </div>
                    <div class="uk-margin uk-text-left">
                        <label class="uk-form-label" for="form-stacked-text">Pārliecības koef. robeža</label>
                        <div class="uk-form-controls">
                            <input v-model.number="limit" type="number" step="0.01" min="0" max="1" class="uk-input uk-form-width-small" placeholder="Limits">
                        </div>
                    </div>
                    <div class="uk-margin uk-text-left">
                        <button @click.prevent="save" class="uk-button uk-margin-right uk-margin-bottom">Saglabāt koef.</button>
                    </div>
                    <div class="uk-margin-large-top">
                        <button v-for="(answer, key) in answers" @click.prevent="learn(key)" :class="'uk-button uk-margin-right uk-margin-bottom ' + answer.class">{{ answer.text }} ({{ answer.coef.toFixed(2) }})</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--<script src="./vendor/js/babel-6.26.0.min.js"></script>-->
<script src="./vendor/js/vue.js"></script>
<script src="./vendor/js/uikit.min.js"></script>
<!--async="false" uikit and vuejs conflict fix-->
<script src="./vendor/js/uikit-icons.min.js" async="false"></script>
<!--<script type="text/babel" data-presets="es2015,stage-2">-->
<script>
    const app = new Vue({
        el: '#app',
        data: {
            questions: {
                '[spid_saule]':   { checked: false, learnChecked: false, coef: 0.01, text: 'Spīd saule?' },
                '[bus_kd]':       { checked: false, learnChecked: false, coef: 0.01, text: 'Būs KD?' },
                '[bija_ballite]': { checked: false, learnChecked: false, coef: 0.01, text: 'Vakar bija ballīte?' },
                '[list_lietus]':  { checked: false, learnChecked: false, coef: 0.01, text: 'Līst lietus?' },
                '[nav_md]':       { checked: false, learnChecked: false, coef: 0.01, text: 'Suns apēda mājas darbu?' },
            },
            answers: {
                '[iet]':   { coef: 0.01, text: 'Ir jaiet',  class: 'uk-button-primary' },
                '[neiet]': { coef: 0.01, text: 'Nav jāiet', class: 'uk-button-danger' },
            },
            limit: 0.3,
            result: false,
            answer: 13
        },
        methods: {
            analyze: function () {
                this.answer = null
                this.result = false
                let conditionsString = ''
                for(const key in this.questions){
                    if(this.questions[key].checked){
                        conditionsString += (conditionsString.length === 0) ?  key : ' AND '+ key
                    }
                }
                if(conditionsString.length > 0){
                    let goStatement = 'IF ' + conditionsString + ' THEN [iet]'
                    let goNotStatement = 'IF ' + conditionsString + ' THEN [neiet]'
                    let go = this.calculateStatement(goStatement)
                    let goNot = this.calculateStatement(goNotStatement)
                    console.log(go)
                    console.log(goNot)
//                    if(go.probability > this.limit && go.probability > goNot.probability){
//                        this.answer = '[iet]'
//                        this.update(goStatement)
//                    }
//                    else if(goNot.probability < this.limit){
//                        this.answer = '[neiet]'
//                        this.update(goNotStatement)
//                    }
                }
                this.result = true
            },
            calculateStatement: function (statement) {
                let answer = statement.substr(statement.indexOf('THEN') + 4).trim()
                let conditions = statement.slice(0, statement.indexOf('THEN')).
                    replace('IF', '').
                    replace(/AND/g, '').
                    replace(/OR/g, '').
                    trim().
                    match(/\[.*?\]/gi)
                let min = conditions.reduce((accumulator, current) => {
                    return (this.questions[current].coef < accumulator) ? this.questions[current].coef : accumulator
                }, 1)
                let probability = min * this.answers[answer].coef
                console.log(statement)
                console.log('min AND coef: ' + min)
                console.log('answer coef: ' + this.answers[answer].coef)
                console.log('statement probability: ' + probability)
                console.log('------------------------------')
                return {
                    result: (probability > this.limit) ? true : false,
                    probability: probability,
                    answer: answer
                }
            },
            update: function(statement){
                let keys = statement.slice(0, statement.indexOf('THEN')).match(/\[.*?\]/gi)
                if(keys && keys.length > 0){
                    let prev = 0.01
                    keys.forEach((key) => {
                        // Pk = Pkold + (1 - Pkold) * Pjaun
                        this.questions[key].coef = this.questions[key].coef + (1 - this.questions[key].coef) * prev
                        prev = this.questions[key].coef
                    })
                    let answer = statement.substr(statement.indexOf('THEN') + 4).trim()
                    this.answers[answer].coef = this.answers[answer].coef + (1 - this.answers[answer].coef) * prev
                }
            },
            learn: function (answer) {
                let conditionsString = ''
                for(const key in this.questions){
                    if(this.questions[key].learnChecked){
                        conditionsString += (conditionsString.length === 0) ?  key : ' AND '+ key
                    }
                }
                let statement = 'IF ' + conditionsString + ' THEN ' + answer + '\n';
                this.update(statement)
            },
            save: function () {
                localStorage.setItem('questions', JSON.stringify(this.questions))
                localStorage.setItem('answers', JSON.stringify(this.answers))
                localStorage.setItem('limit', this.limit)
            }
        },
        mounted: function() {
            if(localStorage.getItem('questions') && localStorage.getItem('answers') && localStorage.getItem('limit')){
                this.questions = JSON.parse(localStorage.getItem('questions'))
                this.answers = JSON.parse(localStorage.getItem('answers'))
                this.limit = parseFloat(localStorage.getItem('limit'))
            }
        }
    })
</script>
</body>
</html>